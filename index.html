<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angie's Crochet Projects</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Paste your Firebase Project config here.
        // It should look like this:
        // const firebaseConfig = {
        //   apiKey: "...",
        //   authDomain: "...",
        //   projectId: "...",
        //   storageBucket: "...",
        //   messagingSenderId: "...",
        //   appId: "..."
        // };
        // Delete the line below and paste your full config here.
       const firebaseConfig = {
  apiKey: "AIzaSyC4GOIC2VzO-fEgTGXEj-dK8I6sQvbARmA",
  authDomain: "angiecrochetapp.firebaseapp.com",
  projectId: "angiecrochetapp",
  storageBucket: "angiecrochetapp.firebasestorage.app",
  messagingSenderId: "938895412535",
  appId: "1:938895412535:web:32577c45b7b14705c49eb2"
};

        
        window.appData = {
            db: null,
            auth: null,
            userId: null,
            appId: '',
            projects: [],
            filteredProjects: [],
            currentProjectId: null,
            isVerticalView: false,
            showFinishedOnly: false,
            isAuthReady: false
        };

        async function initApp() {
            try {
                if (!firebaseConfig.projectId) {
                    console.error("Firebase initialization failed: Project config is not set.");
                    // In a production app, you might show a setup screen here.
                    return; 
                }
                
                const app = initializeApp(firebaseConfig);
                window.appData.db = getFirestore(app);
                window.appData.auth = getAuth(app);
                window.appData.appId = firebaseConfig.projectId;
                
                await signInAnonymously(window.appData.auth);
                window.appData.userId = window.appData.auth.currentUser.uid;
                window.appData.isAuthReady = true;
                
                loadProjects();
                console.log("Firebase initialized successfully.");

                // Now that the app is ready, we can attach the event listeners
                document.getElementById('saveProjectBtn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    const projectName = document.getElementById('projectName').value;
                    const projectCategory = document.getElementById('projectCategory').value;
                    const hookSize = document.getElementById('hookSize').value;
                    const yarn = document.getElementById('yarn').value;
                    const pattern = document.getElementById('pattern').value;
                    const notesLink = document.getElementById('notesLink').value;
                    const projectNotes = document.getElementById('projectNotes').value;
                    const projectId = document.getElementById('projectId').value;
                    const imageFiles = document.getElementById('projectImages').files;
        
                    let currentProject = window.appData.projects.find(p => p.id === projectId);
                    let imageUrls = currentProject ? currentProject.images || [] : [];
                    let mainImage = currentProject ? currentProject.mainImage : null;
                    
                    if (imageFiles.length > 0) {
                        showNotification('Uploading and compressing images...');
                        try {
                            const newImageUrls = await window.uploadImages(imageFiles);
                            imageUrls = [...imageUrls, ...newImageUrls];
                            if (!mainImage) {
                                mainImage = newImageUrls[0];
                            }
                        } catch (error) {
                            console.error("Image upload failed:", error);
                            showNotification('Image upload failed. Please try again.');
                            return;
                        }
                    }
        
                    const projectData = {
                        id: projectId,
                        name: projectName,
                        category: projectCategory,
                        hookSize: hookSize,
                        yarn: yarn,
                        pattern: pattern,
                        notesLink: notesLink,
                        notes: projectNotes,
                        images: imageUrls,
                        mainImage: mainImage
                    };
        
                    await window.saveProject(projectData);
                });

                document.getElementById('deleteProjectBtn').addEventListener('click', async () => {
                    const projectId = document.getElementById('projectId').value;
                    const result = await window.confirm("Are you sure you want to delete this project?");
                    if (result) {
                        await window.deleteProject(projectId);
                    }
                });


            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }
        
        function loadProjects() {
            if (!window.appData.isAuthReady) return;
            const projectsRef = collection(window.appData.db, 'artifacts', window.appData.appId, 'users', window.appData.userId, 'projects');
            onSnapshot(projectsRef, (snapshot) => {
                window.appData.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterProjects(document.getElementById('searchBar').value);
                renderCollage();
                console.log("Projects loaded successfully.");
            }, (error) => {
                console.error("Error loading projects:", error);
                showNotification('Error loading projects. Please try again later.');
            });
        }
        
        window.saveProject = async function(projectData) {
            if (!window.appData.isAuthReady) {
                showNotification('App is not ready. Please wait a moment and try again.');
                return;
            }

            try {
                if (projectData.id) {
                    const docRef = doc(window.appData.db, 'artifacts', window.appData.appId, 'users', window.appData.userId, 'projects', projectData.id);
                    await setDoc(docRef, projectData, { merge: true });
                } else {
                    await addDoc(collection(window.appData.db, 'artifacts', window.appData.appId, 'users', window.appData.userId, 'projects'), {
                        ...projectData,
                        createdAt: serverTimestamp()
                    });
                }
                showNotification('Project saved successfully!');
                closeModal('projectModal');
                
            } catch (e) {
                console.error("Error saving project:", e);
                showNotification('Error saving project. Please try again.');
            }
        }

        window.deleteProject = async function(projectId) {
            if (!window.appData.isAuthReady) {
                showNotification('App is not ready. Please wait a moment and try again.');
                return;
            }

            try {
                await deleteDoc(doc(window.appData.db, 'artifacts', window.appData.appId, 'users', window.appData.userId, 'projects', projectId));
                showNotification('Project deleted successfully!');
                closeModal('projectModal');
            } catch (e) {
                console.error("Error deleting project:", e);
                showNotification('Error deleting project. Please try again.');
            }
        }
        
        // New image resizing and upload function
        window.uploadImages = async function(files) {
            const imageUrls = [];
            for (const file of files) {
                const resizedImage = await resizeAndCompressImage(file);
                imageUrls.push(resizedImage);
            }
            return imageUrls;
        }

        function resizeAndCompressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Max width and height for smaller image, adjust as needed
                        const maxWidth = 800;
                        const maxHeight = 800;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert canvas content to a base64 string
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); // 0.7 is the quality, adjust as needed
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        window.filterProjects = function(query) {
            if (!window.appData.isAuthReady) return;
            const lowerQuery = query.toLowerCase();
            window.appData.filteredProjects = window.appData.projects.filter(project => {
                const searchString = `${project.name} ${project.pattern || ''} ${project.yarn || ''} ${project.hookSize || ''} ${project.notes || ''}`.toLowerCase();
                return searchString.includes(lowerQuery);
            });
            renderProjects();
        };

        window.toggleView = function() {
            window.appData.isVerticalView = !window.appData.isVerticalView;
            renderProjects();
        };

        window.toggleCollageView = function() {
            window.appData.showFinishedOnly = !window.appData.showFinishedOnly;
            renderCollage();
        };
        
        function renderCollage() {
            const collageContainer = document.getElementById('image-collage');
            const finishedToggle = document.getElementById('finishedToggle');
            collageContainer.innerHTML = '';
            
            if (window.appData.showFinishedOnly) {
                finishedToggle.textContent = 'Show All Photos';
            } else {
                finishedToggle.textContent = 'Show Finished Only';
            }

            let images = [];
            let projectsToShow = window.appData.projects;

            if (window.appData.showFinishedOnly) {
                projectsToShow = projectsToShow.filter(p => p.category === 'finished');
            }

            projectsToShow.forEach(project => {
                if (project.images && Array.isArray(project.images) && project.images.length > 0) {
                    if (project.mainImage) {
                        images.push({ url: project.mainImage, createdAt: project.createdAt });
                    } else {
                        images.push({ url: project.images[0], createdAt: project.createdAt });
                    }
                }
            });

            images.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            const displayLimit = 12;
            const imagesToDisplay = images.slice(0, displayLimit);

            if (imagesToDisplay.length === 0) {
                collageContainer.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No photos to display yet.</p>`;
            } else {
                imagesToDisplay.forEach(imgData => {
                    const img = document.createElement('img');
                    img.src = imgData.url;
                    img.classList.add('w-full', 'h-full', 'rounded-lg', 'object-cover', 'shadow-sm', 'transition-transform', 'hover:scale-105');
                    collageContainer.appendChild(img);
                });
            }
        }

        // Initialize app on page load
        initApp();

        document.getElementById('projectImages').addEventListener('change', async (e) => {
            const imagePreviewContainer = document.getElementById('image-preview');
            imagePreviewContainer.innerHTML = '';
            
            showNotification('Processing images for preview...');
            const newImageUrls = await window.uploadImages(e.target.files);
            
            newImageUrls.forEach(imgUrl => {
                const imgWrapper = document.createElement('div');
                imgWrapper.classList.add('relative', 'w-20', 'h-20', 'rounded-lg', 'overflow-hidden', 'group');
                imgWrapper.innerHTML = `
                    <img src="${imgUrl}" alt="Project Image" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="setMainImage('${imgUrl}')" class="bg-white text-gray-800 px-2 py-1 text-xs rounded-full shadow-md hover:bg-gray-100">
                            Set as Main
                        </button>
                    </div>
                `;
                imagePreviewContainer.appendChild(imgWrapper);
            });
            showNotification('Images processed.');
        });
        
        // This is a polyfill for the confirm function to prevent issues on iframes.
        // It provides a basic UI for user confirmation.
        window.confirm = (message) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-message').innerText = message;
                document.getElementById('confirm-yes-btn').onclick = () => {
                    closeModal('confirm-modal');
                    resolve(true);
                };
                document.getElementById('confirm-no-btn').onclick = () => {
                    closeModal('confirm-modal');
                    resolve(false);
                };
                openModal('confirm-modal');
            });
        };

    </script>
</body>
</html>
